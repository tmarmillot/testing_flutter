name: Prepare release with a Pull request
on: 
  workflow_dispatch:

jobs:
  prepare-release:
    runs-on: "ubuntu-latest"
    steps:
      # Checkout
      - name: Checkout
        uses: actions/checkout@v2
      # Get release version
      - name: Get version to release
        uses: mikefarah/yq@master
        id: release-version
        with:
          cmd: "yq e '.version' pubspec.yaml"
    # Create release branch from release version
      - name: remove if exists release/${{steps.release-version.outputs.result}}
        run: ' git push origin --delete release/${{steps.release-version.outputs.result}}'
  
    # Create release branch from release version
      - name: Create branch release/${{steps.release-version.outputs.result}}
        run: 'git switch -c release/${{steps.release-version.outputs.result}} && git push -u origin release/${{steps.release-version.outputs.result}}'
      
      - name: Create commits
        run: |
          git config user.name 'Bernard Release Bot'
          git config user.email 'tmarmillot@users.noreply.github.com'
          date +%s > new-report.txt
          git add -A
          git commit -m "Add untracked file during workflow"
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          branch: release/${{steps.release-version.outputs.result}}
          title: '[Release] welcome ${{steps.release-version.outputs.result}} :bookmark:'